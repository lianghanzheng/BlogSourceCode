---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// Get all blog posts to find index
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
const postIndex = sortedPosts.findIndex((p) => p.slug === post.slug);
---

<BaseLayout title={post.data.title}>
  <div class="flex gap-12">

    <!-- 左侧：目录导航 + 分割线 -->
    <div class="flex items-start gap-8 shrink-0 pt-4">
      <!-- TOC 区域 -->
      <div class="w-28 flex flex-col items-center pt-6">
        <!-- 标题导航 -->
        <TableOfContents headings={headings} />
      </div>

      <!-- 垂直分割线 -->
      <div class="relative w-0.5 h-64 bg-divide mt-8">
        <div class="absolute -top-1 -left-1.5 w-3.5 h-3.5 bg-divide rounded-sm"></div>
        <div class="absolute -bottom-1 -left-1.5 w-3.5 h-3.5 bg-divide rounded-sm"></div>
      </div>
    </div>

    <!-- 右侧：文章内容 -->
    <div class="flex-1 pt-4">
      <article>
        <header class="mb-12 pb-8 border-b border-coffee/10">
          <!-- 三色条带编号卡片 + 标题 -->
          <div class="flex items-start gap-6">
            <!-- 编号卡片 -->
            <div class="shrink-0 select-none">
              <div class="flex h-20 shadow-lg">
                <!-- 彩色条带 -->
                <div class="w-2 h-full bg-sage"></div>
                <div class="w-2 h-full bg-mustard"></div>
                <div class="w-1.5 h-full bg-dark-strip"></div>
                <!-- 数字方块 -->
                <div class="w-20 h-full flex items-center justify-center bg-coffee">
                  <span class="text-3xl font-black tracking-widest text-orange font-mono">
                    {String(postIndex + 1).padStart(2, '0')}
                  </span>
                </div>
              </div>
            </div>

            <!-- 标题信息 -->
            <div class="pt-2">
              <h1 class="text-3xl font-serif font-bold text-coffee mb-2">{post.data.title}</h1>
              {post.data.description && (
                <p class="text-coffee/70 font-serif text-lg">{post.data.description}</p>
              )}
              <p class="text-xs font-mono text-coffee/40 mt-2">{post.data.repo}</p>
            </div>
          </div>
        </header>

        <div class="prose prose-stone prose-lg max-w-none prose-headings:font-serif prose-headings:text-coffee prose-p:text-coffee/80 prose-a:text-orange prose-a:no-underline hover:prose-a:underline prose-code:text-orange prose-code:bg-coffee/5 prose-code:px-1 prose-code:rounded prose-pre:bg-coffee prose-pre:text-cream">
          <Content />
        </div>
      </article>
    </div>
  </div>
</BaseLayout>
